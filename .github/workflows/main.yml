name: CERN Data Analysis Pipeline

# Este workflow se ejecuta cuando se hace push al branch 'main' o 'master'
# o cuando se activa manualmente desde la interfaz de GitHub.
on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  analyze_and_deploy:
    # Usaremos el runner est√°ndar de Ubuntu, que es r√°pido.
    runs-on: ubuntu-latest
    
    # Define la clave para el cach√© de datos. Cambia 'v1' si los URLs de datos cambian.
    env:
      CACHE_KEY: cern-opendata-root-v1

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4
        # Necesario para el despliegue a GitHub Pages al final
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 2. Set up Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Usamos una versi√≥n moderna de Python

      - name: 3. Install Python Dependencies
        run: |
          # Instalamos todas las librer√≠as necesarias
          pip install -r requirements.txt
          
      - name: 4. Restore/Download Data Cache (The Key Step!) üíæ
        uses: actions/cache@v4
        id: cache-data # Asignamos un ID a este paso para poder referenciarlo
        with:
          path: data # Ruta de la carpeta donde analysis.py guarda los archivos .root
          key: ${{ runner.os }}-${{ env.CACHE_KEY }} # Clave √∫nica para el cach√©

      - name: 5. Execute Data Analysis (Python)
        # Solo ejecutamos si el cach√© no existe (descarga) o si el cach√© existe (an√°lisis).
        # El script analysis.py maneja la l√≥gica de descarga/salto.
        run: |
          echo "Starting analysis. This will download files only on first run."
          python analysis.py
          
      - name: 6. Prepare Results (Artifacts)
        # Renombramos la carpeta 'results' para que sea compatible con GitHub Pages
        run: |
          mv results docs
          
      - name: 7. Upload Results as Artifact ‚¨ÜÔ∏è
        uses: actions/upload-artifact@v4
        with:
          name: analysis-results
          path: docs/
          # No es necesario retener el artifact por mucho tiempo si lo desplegamos

      - name: 8. Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs # Publica el contenido de la carpeta 'docs'
          # La opci√≥n 'keep_files: true' es √∫til si tienes otros archivos en gh-pages
          # y solo quieres actualizar el contenido de 'docs'.
          
      - name: 9. Final Setup for GitHub Pages Service
        # Este paso es una nota para recordarte la configuraci√≥n manual
        run: echo "REMINDER: Set GitHub Pages source to 'gh-pages' or 'docs' folder."
