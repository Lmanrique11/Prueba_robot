name: CERN Data Analysis Pipeline (Dos Fases)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  ## --- JOB 1: ANALYZE AND UPLOAD ARTIFACTS (Crea los archivos 'docs/') ---
  analyze:
    runs-on: ubuntu-latest
    env:
      CACHE_KEY: cern-opendata-root-v1
    
    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
              
      - name: 2. Set up Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 3. Install Python Dependencies
        run: pip install -r requirements.txt
              
      - name: 4. Restore/Download Data Cache üíæ
        uses: actions/cache@v4
        id: cache-data
        with:
          path: data
          key: ${{ runner.os }}-${{ env.CACHE_KEY }}

      - name: 5. Execute Data Analysis (Python)
        run: |
          echo "Starting analysis."
          python analysis.py
              
      - name: 6. Prepare Docs Folder
        run: cp -r results/* docs/
                 
      - name: 7. Upload Results as Artifact ‚¨ÜÔ∏è
        uses: actions/upload-artifact@v4
        with:
          name: analysis-docs # Nombre del artefacto creado
          path: docs/

  ## --- JOB 2: DEPLOY TO GITHUB PAGES (Usa los archivos creados) ---
  deploy:
    runs-on: ubuntu-latest
    needs: analyze # Asegura que el Job 1 (analyze) termin√≥ correctamente
    
    # SOLO se ejecuta el despliegue en las ramas principales (main/master)
    if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}
    
    steps:
      - name: 1. Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: analysis-docs # Descarga el artefacto del Job 1
          path: docs/ # Lo descarga directamente en la carpeta 'docs'
          
      - name: 2. Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs
          
      - name: 3. Final Setup Reminder
        run: echo "REMINDER: Set GitHub Pages source to 'docs' folder in repo settings."
